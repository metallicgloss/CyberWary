{% extends "structure/portal.html" %}

{% load static %}
{% load subtract %}

{% comment %}
GNU General Public License v3.0
Cyber Wary - <https://github.com/metallicgloss/CyberWary>
Copyright (C) 2022 - William P - <hello@metallicgloss.com>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.
{% endcomment %}

{% block page_head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables@1.10.18/media/css/jquery.dataTables.min.css" integrity="sha256-YY1izqyhIj4W3iyJOaGWOpXDSwrHWFL4Nfk+W0LyCHE=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-responsive-dt@2.2.9/css/responsive.dataTables.min.css" integrity="sha256-Y/AdBW1nhvzPowuT1lvF4PkY6QR+nqYzBcbmkDCG30Y=" crossorigin="anonymous">
{% endblock%}

{% block page_content %}
    <section>
        <!-- Page Title -->
        <div class="row pb-4">
            <div class="col-lg-12 col-xl-12">
                <button class="btn back-btn p-0 mb-3" onclick="window.location.replace(document.referrer)"><i class="icofont-arrow-left"></i> Back</button>
                <h2 class="mb-0"><span id="scan-title">{{ scan_record.scan.title }}</span></h2>
                <div class="d-flex align-items-start scan-brief">
                    <p class="me-3 mb-3">{% now "l jS F Y" %}</p>
                    <svg width="3" height="3" viewBox="0 0 3 3" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="3" height="3" fill="#34CC96" />
                    </svg>
                    <p class="ms-3 mb-3"><span id="scan-type" class="{% if scan_record.scan.type == "B" %}text-info{% else %}text-danger-alt{% endif %}">{% if scan_record.scan.type == "B" %}Blue{% else %}Red{% endif %} Team</span> Scan</p>
                </div>
            </div>
        </div>

        <!-- Report Content -->
        <div class="row">
            <!-- Report Details -->
            <div class="col-lg-12 col-xl-9">
                <div class="scan-report-container">
                    <div class="scan-report pe-4">
                        <!-- Report Accordion -->
                        <div class="accordion accordion-flush" id="faqAccordion">

                            <!-- Scan Overview -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="flush-headingOne">
                                    <!-- Accordion Tab Title -->
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
                                        <i class="icofont-check-circled me-2 pt-1 text-success"></i> Overview
                                    </button>
                                </h2>
                                <div id="flush-collapseOne" class="accordion-collapse collapse show" aria-labelledby="flush-headingOne" data-bs-parent="#faqAccordion">
                                    <div class="accordion-body">
                                        
                                        <!-- Google Maps -->
                                        <div id="map"></div>

                                        <!-- Accordion Controls -->
                                        <div class="nav-buttons mt-4">
                                            <button class="back btn bg-primary text-white text-uppercase px-4 py-1">Prev</button>
                                            <button class="next btn bg-success text-white text-uppercase px-4 py-1 float-end">Next</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Installed Applications -->
                            {% if scan_record.scan.installed_applications and scan_data.installed_applications.count != 0 %}
                                <div class="accordion-item">
                                    <!-- Accordion Tab Title -->
                                    <h2 class="accordion-header" id="heading-applications">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-applications" aria-expanded="false" aria-controls="collapse-applications">
                                            {% if scan_data.cves > 0 %}
                                                <i class="icofont-exclamation-tringle me-2 text-warning"></i>
                                            {% else %}
                                                <i class="icofont-check-circled me-2 pt-1 text-success"></i>
                                            {% endif %}
                                            Installed Applications
                                        </button>
                                    </h2>

                                    <div id="collapse-applications" class="accordion-collapse collapse" aria-labelledby="heading-applications" data-bs-parent="#faqAccordion">
                                        <div class="accordion-body">
                                            <!-- Installed Applications Explainer -->
                                            <h5 class="mt-4">Installed Applications</h5>
                                            <p class="mb-4">There's a high chance that you've installed at least one third-party application, and you're not relying solely on the Microsoft Store; this component captures a list of all installed applications on your device and then attempts to identify if there are any known vulnerabilities with the version of the software that may indicate that it hasn't been updated.</p>

                                            <!-- Installed Applications Metrics / Charts -->
                                            <div class="row">
                                                <div class="col-xl-6">
                                                    <div id="vulnerabilities" style="margin:auto"></div>
                                                </div>
                                                <div class="col-xl-6">
                                                    <div id="install-by-time" style="margin:auto"></div>
                                                </div>
                                            </div>

                                            <!-- Installed Applications List -->
                                            <h5 class="mt-5">Applications</h5>
                                            <table id="applications" class="display pb-3 w-100">
                                                <thead>
                                                    <tr>
                                                        <th class="py-2 desktop">Application</th>
                                                        <th class="py-2 desktop">Publisher</th>
                                                        <th class="py-2 desktop">Version</th>
                                                        <th class="py-2 desktop">Install Date</th>
                                                        <th class="py-2 desktop">Vulnerabilities</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for application in scan_data.installed_applications %}
                                                        <tr>
                                                            <td>{{ application.name }}</td>
                                                            <td>{{ application.publisher.name }}</td>
                                                            <td>{{ application.version }}</td>
                                                            <td>{% if application.install_date %}{{ application.install_date }}{% else %}Not Set{% endif %}</td>
                                                            <td>
                                                                {% if application.cve_match %}
                                                                    <span class="cve-action text-danger" onclick="viewCVE('{{ application.cpe.identifier }}')" data-toggle="tooltip" data-placement="top" title="Click for full record.">
                                                                        <i class="icofont-exclamation-tringle me-1"></i> Known Vulnerabilities
                                                                    </span>
                                                                {% else %}
                                                                    <span class="text-success">Not Detected in Dataset</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>

                                            <!-- Accordion Controls -->
                                            <div class="nav-buttons mt-4">
                                                <button class="back btn bg-primary text-white text-uppercase px-4 py-1">Prev</button>
                                                <button class="next btn bg-success text-white text-uppercase px-4 py-1 float-end">Next</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Browser Passwords -->
                            {% if scan_record.scan.browser_passwords and scan_data.browser_passwords != None %}
                                <div class="accordion-item">
                                    <!-- Accordion Tab Title -->
                                    <h2 class="accordion-header" id="heading-browser-passwords">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-browser-passwords" aria-expanded="false" aria-controls="collapse-browser-passwords">
                                            {% if scan_data.compromised > 0 %}
                                                <i class="icofont-exclamation-tringle me-2 text-danger"></i>
                                            {% elif scan_data.weak > 0 %}
                                                <i class="icofont-exclamation-tringle me-2 text-warning"></i>
                                            {% else %}
                                                <i class="icofont-check-circled me-2 pt-1 text-success"></i>
                                            {% endif %}
                                            Browser Passwords
                                        </button>
                                    </h2>

                                    <div id="collapse-browser-passwords" class="accordion-collapse collapse" aria-labelledby="heading-browser-passwords" data-bs-parent="#faqAccordion">
                                        <div class="accordion-body">
                                            <!-- Credentials Explainer -->
                                            <h5 class="mt-4">Credentials</h5>
                                            <p class="mb-4">Have excellent password hygiene? Store passwords securely in your browser rather than on paper? Your passwords are only as secure as your system, and anyone with access to your device can quickly view them all; if you're not using a password manager, this component will scan all passwords available on your system to check their strength and if they've been potentially compromised.</p>

                                            <!-- Credentials Metrics / Charts -->
                                            <div class="row">
                                                <div class="col-xl-6">
                                                    <div id="usernames" style="margin:auto"></div>
                                                </div>
                                                <div class="col-xl-6">
                                                    <div id="compromised" style="margin:auto"></div>
                                                </div>
                                            </div>

                                            <!-- Credentials List -->
                                            <h5 class="mt-5">Detected Credentials</h5>
                                            <table id="credentials" class="display pb-3 w-100">
                                                <thead>
                                                    <tr>
                                                        <th class="py-2 desktop">URL</th>
                                                        <th class="py-2 desktop">Username</th>
                                                        <th class="py-2 desktop">Strength</th>
                                                        <th class="py-2 desktop">Compromised</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for credential in scan_data.browser_passwords %}
                                                        <tr>
                                                            <td>{{ credential.url|slice:":40" }}</td>
                                                            <td>
                                                                <span class="payload-action" onclick="viewCredential('{{ credential.id }}')" data-toggle="tooltip" data-placement="top" title="Click for full record.">
                                                                    <i class="icofont-info-circle me-2"></i>{{ credential.username }}
                                                                </span>
                                                            </td>
                                                            <td>
                                                                {% if credential.password_strength != 5 %}
                                                                    <span class="text-warning">{{ credential.get_password_strength_display }}</span>
                                                                {% else %}
                                                                    <span class="text-success">{{ credential.get_password_strength_display }}</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if credential.compromised %}
                                                                    <span class="text-danger"><i class="icofont-exclamation-tringle me-2"></i>Potentially Compromised</span>
                                                                {% else %}
                                                                    Not Detected in Dataset
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                            <p class="pb-2"><small>Password breach data supplied by the <a href="https://haveibeenpwned.com/Passwords" class="text-success">Have I Been Pwned</a> project.</small></p>

                                            <!-- Accordion Controls -->
                                            <div class="nav-buttons mt-4">
                                                <button class="back btn bg-primary text-white text-uppercase px-4 py-1">Prev</button>
                                                <button class="next btn bg-success text-white text-uppercase px-4 py-1 float-end">Next</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Windows Update -->
                            {% if scan_record.scan.installed_patches and scan_data.patches_installed.count != 0 %}
                                <div class="accordion-item">
                                    <!-- Accordion Tab Title -->
                                    <h2 class="accordion-header" id="heading-installed-patches">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-installed-patches" aria-expanded="false" aria-controls="collapse-installed-patches">
                                            {% if scan_data.pending_patches.count > 1 or scan_data.installed_patches.count < 5 %}
                                                <i class="icofont-exclamation-tringle me-2 text-warning"></i>
                                            {% else %}
                                                <i class="icofont-check-circled me-2 pt-1 text-success"></i>
                                            {% endif %}
                                            Operating System Patches
                                        </button>
                                    </h2>

                                    <div id="collapse-installed-patches" class="accordion-collapse collapse" aria-labelledby="heading-installed-patches" data-bs-parent="#faqAccordion">
                                        <div class="accordion-body">
                                            <!-- Installed Patches Explainer -->
                                            <h5 class="mt-4">Windows Update</h5>
                                            <p class="mb-4">The notorious Windows Update; <strike>love it</strike> hate it or hate it, Windows Update is one of the most powerful tools in the Windows ecosystem allowing for security patches to be quickly distributed to all users, and it enables feature <i>improvements</i> to be delivered automatically. This component checks to ensure that you're not clicking "Update Later" too much and are now missing essential updates.</p>

                                            <!-- Installed Patch List -->
                                            <h5 class="mt-5">Installed Updates</h5>
                                            <table id="installed-patches" class="display pb-3 w-100">
                                                <thead>
                                                    <tr>
                                                        <th class="py-2 desktop">Date</th>
                                                        <th class="py-2 desktop">Title</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for patch in scan_data.installed_patches %}
                                                        <tr>
                                                            <td>{{ patch.date|date:"l jS F Y - H:i e" }}</td>
                                                            <td>{{ patch.title }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>

                                            {% if scan_data.pending_patches.count > 0%}
                                                <!-- Pending Updates List -->
                                                <h5 class="mt-5">Pending Updates</h5>
                                                <table id="pending-patches" class="display pb-3 w-100">
                                                    <thead>
                                                        <tr>
                                                            <th class="py-2 desktop text-warning">Title</th>
                                                            <th class="py-2 desktop text-warning">Downloaded</th>
                                                            <th class="py-2 desktop text-warning">Mandatory</th>
                                                            <th class="py-2 desktop text-warning">Security Rating</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for patch in scan_data.pending_patches %}
                                                            <tr>
                                                                <td>{{ patch.title }}</td>
                                                                <td>{% if patch.downloaded %}Yes{% else %}No{% endif %}</td>
                                                                <td>{% if patch.mandatory %}Yes{% else %}No{% endif %}</td>
                                                                <td>{{ patch.security_rating }}</td>
                                                            
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            {% endif %}

                                            <!-- Accordion Controls -->
                                            <div class="nav-buttons mt-4">
                                                <button class="back btn bg-primary text-white text-uppercase px-4 py-1">Prev</button>
                                                <button class="next btn bg-success text-white text-uppercase px-4 py-1 float-end">Next</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- AntiVirus Settings -->
                            {% if scan_record.scan.installed_antivirus and scan_data.antivirus_preferences != None %}
                                <div class="accordion-item">
                                    <!-- Accordion Tab Title -->
                                    <h2 class="accordion-header" id="heading-windows-defender">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-windows-defender" aria-expanded="false" aria-controls="collapse-windows-defender">
                                            {% if scan_data.antivirus_detections.count > 0 %}
                                                <i class="icofont-exclamation-tringle me-2 text-danger"></i>
                                            {% elif scan_data.antivirus_exclusions.count > 0 %}
                                                <i class="icofont-exclamation-tringle me-2 text-warning"></i>
                                            {% else %}
                                                <i class="icofont-check-circled me-2 pt-1 text-success"></i>
                                            {% endif %}
                                            Windows Defender Status
                                        </button>
                                    </h2>

                                    <div id="collapse-windows-defender" class="accordion-collapse collapse" aria-labelledby="heading-windows-defender" data-bs-parent="#faqAccordion">
                                        <div class="accordion-body">
                                            <!-- Windows Defender Explainer -->
                                            <h5 class="mt-4">Windows Defender</h5>
                                            <p class="mb-4">Windows Defender Anti-Virus is enabled by default on all new installations of Windows Home and is usually sufficient in protecting users from all typical problems they may experience. This component does a once-over to ensure that there are no altered settings that may leave your system vulnerable, that there are no exclusions hiding malware, and that you don't have any recent detections. </p>

                                            <div class="row pb-4">
                                                <div class="col-xl-6">
                                                    <!-- Windows Defender Status -->
                                                    <h5 class="mt-5 ">Status Warnings</h5>
                                                    {% if not scan_data.antivirus_status.behavior_monitoring %}<p class="mb-0">Behaviour monitoring has been manually <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if not scan_data.antivirus_status.tamper_protection %}<p class="mb-0">Tamper protection has been manually <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if not scan_data.antivirus_status.realtime_protection %}<p class="mb-0">Real-time protection has been manually <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if not scan_data.antivirus_status.download_protection %}<p class="mb-0">Download scanning has been manually <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if not scan_data.antivirus_status.access_protection %}<p class="mb-0">Controlled folder access has not yet been activated.</p>{% endif %}
                                                </div>
                                                <div class="col-xl-6">
                                                    <!-- Windows Defender Preferences -->
                                                    <h5 class="mt-5">Preference Warnings</h5>
                                                    {% if not scan_data.antivirus_preferences.check_for_signatures_before_running_scan %}<p class="mb-0">Automatic signature checks before scans has been <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if scan_data.antivirus_preferences.disable_archive_scanning %}<p class="mb-0">The scanning of archives (compressed files) has been <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if scan_data.antivirus_preferences.disable_block_at_first_seen %}<p class="mb-0">Automatic prevention of unknown malware has been <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if scan_data.antivirus_preferences.disable_cpu_throttle_on_idle_scans %}<p class="mb-0"><abbr title="Central Processing Unit">CPU</abbr> throttling during a scan has been <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if scan_data.antivirus_preferences.disable_datagram_processing %}<p class="mb-0">The scanning of <abbr title="User Datagram Protocol">UDP</abbr> traffic has been <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if scan_data.antivirus_preferences.disable_dns_parsing %}<p class="mb-0">The scanning of <abbr title="Domain Name System">DNS</abbr> traffic has been <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if scan_data.antivirus_preferences.disable_ftp_parsing %}<p class="mb-0">The scanning of <abbr title="File Transfer Protocol">FTP</abbr> traffic has been <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if scan_data.antivirus_preferences.disable_http_parsing %}<p class="mb-0">The scanning of <abbr title="Hypertext Transfer Protocol">HTTP</abbr> traffic has been <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if scan_data.antivirus_preferences.disable_tls_parsing %}<p class="mb-0">The scanning of <abbr title="Transport Layer Security">TLS</abbr> traffic has been <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if scan_data.antivirus_preferences.disable_ssh_parsing %}<p class="mb-0">The scanning of <abbr title="Secure Shell Protocol">SSH</abbr> traffic has been <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if scan_data.antivirus_preferences.disable_rdp_parsing %}<p class="mb-0">The scanning of <abbr title="Remote Desktop Protocol">RDP</abbr> traffic has been <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if scan_data.antivirus_preferences.disable_email_scanning %}<p class="mb-0">The scanning of emails has been <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if scan_data.antivirus_preferences.disable_inbound_connection_filtering %}<p class="mb-0">Inbound traffic scanning has been <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if scan_data.antivirus_preferences.disable_restore_point %}<p class="mb-0">Restore points have been <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if scan_data.antivirus_preferences.disable_scanning_network_files %}<p class="mb-0">The scanning of mapped network drives has been <span class="text-danger">disabled</span>.</p>{% endif %}
                                                    {% if scan_data.antivirus_preferences.disable_script_scanning %}<p class="mb-0">The scanning of PowerShell scripts has been <span class="text-danger">disabled</span>.</p>{% endif %}
                                               </div>
                                            </div>
                                            <hr>
                                            <div class="row py-4">
                                                <div class="col-xl-4">
                                                    <!-- Windows Defender AV Status -->
                                                    <h5>Anti-Virus</h5>
                                                    <p class="mb-0"><strong>Status</strong>: {% if scan_data.antivirus_status.av_enabled %}<i class="icofont-check-circled text-success"></i>{% else %}<i class="icofont-close-squared text-danger" data-toggle="tooltip" data-placement="top" title="This service should be running."></i>{% endif %}</p>
                                                    <p class="mb-0"><strong>Last Updated</strong>: {{ scan_data.antivirus_status.av_signature_update|date:"d/m/Y - H:i e" }}</span>
                                                    <p class="mb-0"><strong>Signature Version</strong>: {{ scan_data.antivirus_status.av_signature_version }}</p>
                                                </div>
                                                <div class="col-xl-4">
                                                    <!-- Windows Defender AS Preferences -->
                                                    <h5>Anti-Spyware</h5>
                                                    <p class="mb-0"><strong>Status</strong>: {% if scan_data.antivirus_status.as_enabled %}<i class="icofont-check-circled text-success"></i>{% else %}<i class="icofont-close-squared text-danger" data-toggle="tooltip" data-placement="top" title="This service should be running."></i>{% endif %}</p>
                                                    <p class="mb-0"><strong>Last Updated</strong>: {{ scan_data.antivirus_status.as_signature_update|date:"d/m/Y - H:i e" }}</span>
                                                    <p class="mb-0"><strong>Signature Version</strong>: {{ scan_data.antivirus_status.as_signature_version }}</p>
                                                </div>
                                                <div class="col-xl-4">
                                                    <!-- Windows Defender NRI Preferences -->
                                                    <h5>Network Inspection</h5>
                                                    <p class="mb-0"><strong>Status</strong>: {% if scan_data.antivirus_status.nri_enabled %}<i class="icofont-check-circled text-success"></i>{% else %}<i class="icofont-close-squared text-danger" data-toggle="tooltip" data-placement="top" title="This service should be running."></i>{% endif %}</p>
                                                    <p class="mb-0"><strong>Last Updated</strong>: {{ scan_data.antivirus_status.nri_signature_update|date:"d/m/Y - H:i e" }}</span>
                                                    <p class="mb-0"><strong>Signature Version</strong>: {{ scan_data.antivirus_status.nri_signature_version }}</p>
                                                </div>
                                            </div>
                                            <hr>

                                            {% if scan_data.antivirus_detections.count > 0 %}
                                                <!-- Windows Defender Detections List -->
                                                <h5 class="mt-5">Detections</h5>
                                                <p>You've had a recent detection of malware or malicious application on your device; this isn't indicative of the current infection status, but if you're not acutely aware of when/where/why/what the file flagged is, it would be worth reviewing your online habits and try running a full malware scan.</p>
                                                <table id="windows-av-detections" class="display pb-3 w-100">
                                                    <thead>
                                                        <tr>
                                                            <th class="py-2 desktop text-danger">Detection Time</th>
                                                            <th class="py-2 desktop text-danger">Active User</th>
                                                            <th class="py-2 desktop text-danger">Detected Resources</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for detection in scan_data.antivirus_detections %}
                                                            <tr>
                                                                <td>{{ detection.detection_time|date:"l jS F Y - H:i e" }}</td>
                                                                <td>{{ detection.active_user }}</td>
                                                                <td>
                                                                    <span class="payload-action" onclick="viewResources('{{ detection.detected_resources }}')" data-toggle="tooltip" data-placement="top" title="Click for detected resources.">
                                                                        <i class="icofont-exclamation-tringle me-2 text-danger"></i> View Resources
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                                <hr>
                                            {% endif %}

                                            {% if scan_data.antivirus_exclusions.count > 0 %}
                                                <!-- Windows Defender Exclusions List -->
                                                <h5 class="mt-4">Exclusions</h5>
                                                <p>Your system has exclusions for files or paths that are not included in malware scans by Windows Defender; it's typically not recommended to have any form of exclusion, but if you have to have some - that's fine. If you're unsure what or why an exclusion exists, remove it, run a full malware scan, and then look into what it is.</p>
                                                <table id="windows-av-exclusions" class="display pb-3 w-100">
                                                    <thead>
                                                        <tr>
                                                            <th class="py-2 desktop text-warning">Exclusion Type</th>
                                                            <th class="py-2 desktop text-warning">Excluded Value</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for exclusion in scan_data.antivirus_exclusions %}
                                                            <tr>
                                                                <td>{{ exclusion.get_type_display }}</td>
                                                                <td>{{ exclusion.value }}</td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            {% endif %}

                                            <!-- Accordion Controls -->
                                            <div class="nav-buttons mt-4">
                                                <button class="back btn bg-primary text-white text-uppercase px-4 py-1">Prev</button>
                                                <button class="next btn bg-success text-white text-uppercase px-4 py-1 float-end">Next</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- System Users -->
                            {% if scan_record.scan.system_users and scan_data.system_users.count != 0 %}
                                <div class="accordion-item">
                                    <!-- Accordion Tab Title -->
                                    <h2 class="accordion-header" id="heading-system-users">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-system-users" aria-expanded="false" aria-controls="collapse-system-users">
                                            {% if scan_data.enabled_defaults > 0 or scan_data.system_users.count > 5 %}
                                                <i class="icofont-exclamation-tringle me-2 text-warning"></i>
                                            {% else %}
                                                <i class="icofont-check-circled me-2 pt-1 text-success"></i>
                                            {% endif %}
                                            System Users
                                        </button>
                                    </h2>

                                    <div id="collapse-system-users" class="accordion-collapse collapse" aria-labelledby="heading-system-users" data-bs-parent="#faqAccordion">
                                        <div class="accordion-body">
                                            <!-- System User Explainer -->
                                            <h5 class="mt-4">User Accounts</h5>
                                            <p class="mb-4">This component reviews your current system settings to ensure that there are no enabled systems accounts and that your account settings are configured correctly; a check is also performed to ensure that user-created profiles have been converted to a Microsoft account to allow for easy local password bypass attacks to take place.</p>

                                            <!-- System User List -->
                                            <h5 class="mt-5">System Users</h5>
                                            <table id="system-users" class="display pb-3 w-100">
                                                <thead>
                                                    <tr>
                                                        <th class="py-2 desktop">Name</th>
                                                        <th class="py-2 desktop">Type</th>
                                                        <th class="py-2 desktop">Last Login</th>
                                                        <th class="py-2 desktop">Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for user in scan_data.system_users %}
                                                        <tr>
                                                            <td>{{ user.name }} {% if user.full_name %}({{ user.full_name }}){% endif %}</td>
                                                            <td>
                                                                {% if user.name not in 'Administrator,DefaultAccount,Guest,WDAGUtilityAccount' and user.source != 2 %}
                                                                    <span class="text-warning" data-toggle="tooltip" data-placement="top" title="Account should be converted to a Microsoft login to improve security."><i class="icofont-info-circle me-1"></i>
                                                                {% else %}
                                                                    <span class="text-success">
                                                                {% endif %}
                                                                    {{ user.get_source_display }}
                                                                </span>
                                                            </td>
                                                            <td>{% if user.last_logon %}{{ user.last_logon|date:"l jS F Y - H:i e" }}{% else %}Never Logged In{% endif %}</td>
                                                            <td>
                                                                {% if user.name in 'Administrator,DefaultAccount,Guest,WDAGUtilityAccount' and user.enabled %}
                                                                    <span class="text-danger" data-toggle="tooltip" data-placement="top" title="Default system accounts should not be enabled."><i class="icofont-info-circle me-1"></i>
                                                                {% else %}
                                                                    <span class="text-success">
                                                                {% endif %}
                                                                        {% if user.enabled %}Enabled</span>{% else %}Disabled{% endif %}
                                                                    </span>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>

                                            <!-- Accordion Controls -->
                                            <div class="nav-buttons mt-4">
                                                <button class="back btn bg-primary text-white text-uppercase px-4 py-1">Prev</button>
                                                <button class="next btn bg-success text-white text-uppercase px-4 py-1 float-end">Next</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div> <!-- End of Accordion -->
                    </div> <!-- End of Report -->
                </div> <!-- End of Container -->
            </div> <!-- End of Column -->
            
            <!-- Scan Metrics -->
            <div class="col-lg-12 col-xl-3">
                <div class="scan-info ps-4">
                    <h5>Scan Record</h5>
                    <p class="mb-2">Start Date/Time: <span>{{ scan_record.created|date:"d/m/Y H:i" }}</span></p>
                    {% if scan_record.progress == 1 %}
                        <!-- Scan Actively Processing / Collecting Stats -->
                        <span><i class="icofont-infinite"></i> Scan In Progress</span>
                    {% else %}
                        <!-- Scan Completed -->
                        <p class="mb-2">End Date/Time: <span>{{ scan_record.updated|date:"d/m/Y H:i" }}</span></p>
                        <p class="mb-2">Duration: <span>{{ scan_duration.0 }}m {{ scan_duration.1 }}s</span></p>
                    {% endif %}
                </div>
            </div> <!-- End of Column -->
        </div> <!-- End of Row -->
        
        <!-- CVE Popup Modal -->
        <div class="modal fade" id="cveModal" tabindex="-1" aria-labelledby="cveModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <!-- Modal Header -->
                    <div class="modal-header">
                        <h5 class="modal-title">Associated CVE Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <!-- Modal Body / Contents -->
                    <div class="modal-body">
                        <div class="scan-info">
                            <!-- CVE Explainer Details -->
                            <p class="mb-2"><i class="icofont-info-circle me-2"></i><span>Details:</span> ipsum lorem</p>
                            <p class="mb-2"><i class="icofont-flag me-2"></i><span>Recommended Action:</span> Update or Remove Application</p>
                        </div>
                        <!-- Horizontal Divider -->
                        <hr>

                        <!-- CVE List -->
                        <table id="cve-modal-table" class="display pb-3 w-100">
                            <thead>
                                <tr>
                                    <th class="py-2 desktop">CVE Identifier</th>
                                    <th class="py-2 desktop">Severity Rating</th>
                                    <th class="py-2 desktop">Severity Score</th>
                                    <th class="py-2 desktop">Published</th>
                                    <th class="py-2 desktop">References</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Credential Popup Modal -->
        <div class="modal fade" id="credentialModal" tabindex="-1" aria-labelledby="credentialModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <!-- Modal Header -->
                    <div class="modal-header">
                        <h5 class="modal-title">Credential Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <!-- Modal Body / Contents -->
                    <div class="modal-body">
                        <div class="scan-info">
                            <!-- Credential Details -->
                            <p class="mb-2"><i class="icofont-ui-user me-2"></i>Username: <span id="credUsername"></span></p>
                            <p class="mb-2"><i class="icofont-chart-histogram me-2"></i>Password Strength: <span id="credStrength"></span></p>
                            <p class="mb-2"><i class="icofont-web me-2"></i>URL: <span id="credURL"></span></p>
                            <p class="mb-2"><i class="icofont-dashboard-web me-2"></i>Browser: <span id="credBrowser"></span></p>
                            <p class="mb-2"><i class="icofont-file-sql me-2"></i>Storage Location: <span id="credFilename"></span></p>

                            <!-- Horizontal Divider -->
                            <hr>
                            
                            <!-- Compromise Details -->
                            <p class="mb-2"><i class="icofont-danger-zone me-2"></i>Compromised: <span id="credCompromised"></span></p>
                            <p class="mb-2"><i class="icofont-pie-chart me-2"></i>Occurrence (Number of Times Seen in a Breach): <span id="credOccurrence"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Defender Resources Popup Modal -->
        <div class="modal fade" id="defenderResourceModal" tabindex="-1" aria-labelledby="defenderResourceModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <!-- Modal Header -->
                    <div class="modal-header">
                        <h5 class="modal-title">Detected Resources</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <!-- Modal Body / Contents -->
                    <div class="modal-body">
                        <div class="scan-info">
                            <p class="mb-2">The following resources have been previously detected on your system;</p>
                            <p id="resources"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}


{% block page_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/datatables@1.10.18/media/js/jquery.dataTables.min.js" integrity="sha256-3aHVku6TxTRUkkiibvwTz5k8wc7xuEr1QqTB+Oo5Q7I=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net-responsive@2.2.9/js/dataTables.responsive.min.js" integrity="sha256-f+r2TX3KkC6avpv7F8bRhVZZO8nW7xJhmCKd6k7PqGE=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.2.2/dist/echarts.min.js" integrity="sha256-iJxB0L7blNZTAFBu/ESTfVaVTqFrTeISeWk7RUEePFY=" crossorigin="anonymous"></script>
    <script>
        // Dynamic variable declaration
        var latitude = {{ coords.0 }}
        var longitude = {{ coords.1 }}
        var icon = "{% static 'imgs/map.png' %}"
        var title = "{{ scan_record.name }}"
        var csrfToken = "{{ csrf_token }}"

        {% if scan_record.scan.installed_applications %}
            // Credential dynamic variables
            var cve = true
            var cveURL = "{% url 'cve' %}"

            var totalApplications = {{ scan_data.installed_applications_count }}
            var totalCVEs = {{ scan_data.cves }}
            var vulnerableApplications = {{ scan_data.vulnerable_applications }}

            // Chart Timeline Data
            var installTimeline = [
                [
                    "Installed",
                    "Installed Applications",
                    "Day"
                ],
                {% for record in scan_data.install_timeline %}
                    [
                        "Installed Applications",
                        {{ record.running_total }},
                        "{{ record.install_date }}"
                    ],
                {% endfor %}
            ]
        {% endif %}

        {% if scan_record.scan.browser_passwords and scan_data.browser_passwords != None %}
            // Credential dynamic variables
            var credentials = true
            var credentialURL = "{% url 'credential' %}"

            // Chart Dataset
            var usernameData = [
                {% for username in scan_data.usernames %}
                    {
                        value: {{ username.username__count }},
                        name: '{{ username.username }}'
                    },
                {% endfor %}
            ]

            var compromisedColor = {% if scan_data.compromised > 0 %}'#f54b4b'{% else %}'#272727'{% endif %}
            var compromisedValue = {{ scan_data.compromised }}
            var undetectedValue = {{ scan_data.browser_passwords.count|subtract:scan_data.compromised }}
        {% endif %}

        
        {% if scan_record.scan.installed_antivirus %}
            // Credential dynamic variables
            var antivirus = true
        {% endif %}
    </script>
    <script src="{% static 'js/report-extras.js' %}"></script>
    <script async src="https://maps.googleapis.com/maps/api/js?key={{ maps_key }}&callback=initMap"></script>
{% endblock %}