{% extends "portal.html" %}

{% load static %}

{% comment %}
GNU General Public License v3.0
Cyber Wary - <https://github.com/metallicgloss/CyberWary>
Copyright (C) 2021 - William P - <hello@metallicgloss.com>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.
{% endcomment %}

{% block page_content %}
    <div class="row pb-4">
        <div class="col-lg-12 col-xl-12">
            <button class="btn back-btn p-0 mb-3" onclick="history.back()"><i class="icofont-arrow-left"></i> Back</button>
            <h2 class="mb-0"><span id="scan-title">{{ scan_record.scan.title }}</span></h2>
            <div class="d-flex align-items-start scan-brief">
                <p class="me-3 mb-3">{% now "l jS F Y" %}</p>
                <svg width="3" height="3" viewBox="0 0 3 3" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="3" height="3" fill="#34CC96" />
                </svg>
                <p class="ms-3 mb-3"><span id="scan-type" class="{% if scan_record.scan.type == "B" %}text-info{% else %}text-danger-alt{% endif %}">{% if scan_record.scan.type == "B" %}Blue{% else %}Red{% endif %} Team</span> Scan</p>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12 col-xl-9">
            <div class="scan-report-container">
                <div class="scan-report pe-4">
                    <div class="accordion accordion-flush" id="faqAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="flush-headingOne">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
                                    <i class="icofont-check-circled me-2 pt-1 text-success"></i> Overview
                                </button>
                            </h2>
                            <div id="flush-collapseOne" class="accordion-collapse collapse show" aria-labelledby="flush-headingOne" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <div id="map"></div>
                                    <div class="nav-buttons mt-3">
                                        <button class="back btn bg-primary text-white text-uppercase px-4 py-1">Prev</button>
                                        <button class="next btn bg-success text-white text-uppercase px-4 py-1 float-end">Next</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="flush-headingTwo">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">
                                    <i class="icofont-close-squared me-2 text-danger"></i> Scan Item
                                </button>
                            </h2>
                            <div id="flush-collapseTwo" class="accordion-collapse collapse" aria-labelledby="flush-headingTwo" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <div class="nav-buttons mt-3">
                                        <button class="back btn bg-primary text-white text-uppercase px-4 py-1">Prev</button>
                                        <button class="next btn bg-success text-white text-uppercase px-4 py-1 float-end">Next</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% if scan_record.scan.browser_passwords %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading-browser-passwords">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-browser-passwords" aria-expanded="false" aria-controls="collapse-browser-passwords">
                                        <i class="icofont-exclamation-tringle me-2 text-warning"></i> Browser Passwords
                                    </button>
                                </h2>
                                <div id="collapse-browser-passwords" class="accordion-collapse collapse" aria-labelledby="heading-browser-passwords" data-bs-parent="#faqAccordion">
                                    <div class="accordion-body">
                                        <p>
                                            {{ scan_data.browser_passwords.count }}
                                        </p>
                                        <div class="row">
                                            <div class="col-xl-6">
                                            </div>
                                            <div class="col-xl-6">
                                                
                                            </div>
                                        </div>
                                        <table class="display pb-3 w-100">
                                            <thead>
                                                <tr>
                                                    <th class="pb-2 desktop">URL</th>
                                                    <th class="pb-2 desktop">Username</th>
                                                    <th class="pb-2 desktop">Password Strength</th>
                                                    <th class="pb-2 desktop">Compromised</th>
                                                    <th class="pb-2 desktop">View Details</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for credential in scan_data.browser_passwords %}
                                                    <tr>
                                                        <td>{{ credential.url|slice:":48" }}</td>
                                                        <td>{{ credential.username }}</td>
                                                        <td>{{ credential.get_password_strength_display }}</td>
                                                        <td>{% if credential.compromised %}<i class="icofont-exclamation-tringle me-2 text-warning"></i>Potentially Compromised{% else %}Not Detected{% endif %}</td>
                                                        <td>
                                                            <span class="payload-action" onclick="viewCredential('{{ credential.id }}')">
                                                                View Credential
                                                            </span>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        <p>Compromise Status Check Provided By HaveIBeenPwned</p>
                                        <div class="nav-buttons mt-3">
                                            <button class="back btn bg-primary text-white text-uppercase px-4 py-1">Prev</button>
                                            <button class="next btn bg-success text-white text-uppercase px-4 py-1 float-end">Next</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="flush-headingThree">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseThree" aria-expanded="false" aria-controls="flush-collapseThree">
                                    Accordion Item #3
                                </button>
                            </h2>
                            <div id="flush-collapseThree" class="accordion-collapse collapse" aria-labelledby="flush-headingThree" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <div class="nav-buttons mt-3">
                                        <button class="back btn bg-primary text-white text-uppercase px-4 py-1">Prev</button>
                                        <button class="next btn bg-success text-white text-uppercase px-4 py-1 float-end">Next</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-12 col-xl-3">
            <div class="scan-info ps-4">
                <h5>Scan Record</h5>
                <p class="mb-2">Start Date/Time: <span>{{ scan_record.created|date:"d/m/Y H:i" }}</span></p>
                {% if scan_record.progress != 3 or 4 %}
                    <span><i class="icofont-infinite"></i> Scan In Progress</span>
                {% else %}
                    <p class="mb-2">End Date/Time: <span>{{ scan_record.updated|date:"d/m/Y H:i" }}</span></p>
                    <p class="mb-2">Duration: <span>{{ scan_duration.0 }}m {{ scan_duration.1 }}s</span></p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="credentialModal" tabindex="-1" aria-labelledby="credentialModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Credential Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="scan-info">
                        <p class="mb-2"><i class="icofont-ui-user me-2"></i>Username: <span id="credUsername"></span></p>
                        <p class="mb-2"><i class="icofont-chart-histogram me-2"></i>Password Strength: <span id="credStrength"></span></p>
                        <p class="mb-2"><i class="icofont-calendar me-2"></i>Password Creation / Save Date: <span id="credStorage"></span></p>
                        <p class="mb-2"><i class="icofont-web me-2"></i>URL: <span id="credURL"></span></p>
                        <p class="mb-2"><i class="icofont-dashboard-web me-2"></i>Browser: <span id="credBrowser"></span></p>
                        <p class="mb-2"><i class="icofont-file-sql me-2"></i>Storage Location: <span id="credFilename"></span></p>
                        <hr>
                        <p class="mb-2"><i class="icofont-danger-zone me-2"></i>Compromised: <span id="credCompromised"></span></p>
                        <p class="mb-2"><i class="icofont-pie-chart me-2"></i>Occurrence: <span id="credOccurrence"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block page_scripts %}
<script async src="https://maps.googleapis.com/maps/api/js?key={{ maps_key }}&callback=initMap"></script>
<script>
    $(document).ready(function(){
        $('.accordion-body button').click(function() {
            if($(this).is('.next')){
                $(this).closest('.accordion-item').next().find('.accordion-collapse').collapse('show')
            } else {
                $(this).closest('.accordion-item').prev().find('.accordion-collapse').collapse('show')
            }
        });
    });

    function viewCredential(credentialID) {
        $.ajax({
            type: "POST",
            url: "{% url 'credential' %}",
            dataType: "json",
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                credentialID
            },
            success: function(data) {
                $('#credUsername').text(data.username);
                $('#credStrength').text(data.password_strength);
                $('#credStorage').text(data.storage);
                $('#credURL').text(data.url);
                $('#credBrowser').text(data.browser);
                $('#credFilename').text(data.filename);

                if(data.compromised) {
                    $('#credCompromised').text("Potentially Compromised");
                } else {
                    $('#credCompromised').text("Not Detected");
                }
                $('#credOccurrence').text(data.occurrence);
                $('#credentialModal').modal('show');
            }
        });
    }
    
    function initMap() {
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 9,
            center: {
                lat: {{ coords.0 }},
                lng: {{ coords.1 }}
            },
            disableDefaultUI: true,
            styles: [
                {
                    "elementType":"geometry",
                    "stylers":[
                        {
                            "color":"#1d1c28"
                        }
                    ]
                },
                {
                    "elementType":"labels.icon",
                    "stylers":[
                        {
                            "visibility":"off"
                        }
                    ]
                },
                {
                    "elementType":"labels.text.stroke",
                    "stylers":[
                        {
                            "visibility":"off"
                        }
                    ]
                },
                {
                    "featureType":"administrative",
                    "elementType":"labels.text.fill",
                    "stylers":[
                        {
                            "color":"#e9e9e9"
                        }
                    ]
                },
                {
                    "featureType":"landscape.natural",
                    "elementType":"labels",
                    "stylers":[
                        {
                            "visibility":"off"
                        }
                    ]
                },
                {
                    "featureType":"poi",
                    "stylers":[
                        {
                            "visibility":"off"
                        }
                    ]
                },
                {
                    "featureType":"road",
                    "elementType":"geometry",
                    "stylers":[
                        {
                            "color":"#2e2d40"
                        }
                    ]
                },
                {
                    "featureType":"road",
                    "elementType":"labels",
                    "stylers":[
                        {
                            "visibility":"off"
                        }
                    ]
                },
                {
                    "featureType":"road",
                    "elementType":"labels.icon",
                    "stylers":[
                        {
                            "visibility":"off"
                        }
                    ]
                },
                {
                    "featureType":"transit",
                    "stylers":[
                        {
                            "visibility":"off"
                        }
                    ]
                },
                {
                    "featureType":"water",
                    "elementType":"geometry",
                    "stylers":[
                        {
                            "color":"#3a3850"
                        }
                    ]
                },
                {
                    "featureType":"water",
                    "elementType":"labels.text.fill",
                    "stylers":[
                        {
                            "color":"#ffffff"
                        }
                    ]
                }
            ],
        });
      
        new google.maps.Marker({
            position: {
                lat: {{ coords.0 }},
                lng: {{ coords.1 }}
            },
            map,
            icon: "{% static 'imgs/map.png' %}",
            title: "{{ scan_record.name }}",
        });
    }
</script>
{% endblock %}