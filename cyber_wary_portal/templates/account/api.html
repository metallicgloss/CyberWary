{% extends "portal.html" %}

{% load static %}

{% comment %}
GNU General Public License v3.0
Cyber Wary - <https://github.com/metallicgloss/CyberWary>
Copyright (C) 2021 - William P - <hello@metallicgloss.com>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.
{% endcomment %}

{% block page_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables@1.10.18/media/css/jquery.dataTables.min.css" integrity="sha256-YY1izqyhIj4W3iyJOaGWOpXDSwrHWFL4Nfk+W0LyCHE=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-responsive-dt@2.2.9/css/responsive.dataTables.min.css" integrity="sha256-Y/AdBW1nhvzPowuT1lvF4PkY6QR+nqYzBcbmkDCG30Y=" crossorigin="anonymous">
{% endblock%}

{% block page_content %}
    <h2>CyberWary API</h2>
    <p>View and regenerate your API key, or explore your request history.</p>
    <div class="row mt-5">
        <div class="col-lg-12 col-xl-3">
            <div class="account-information">
                <h5 class="mb-4">API Details</h5>
                <p class="mb-0 fw-bold">Current API Key</p>
                <p><code><span class="fw-bold">{{ api_key.key }}</span></code></p>
                <p class="mb-0 fw-bold">Key Creation</p>
                <p><code><span class="fw-bold">{{ api_key.created|date:"l jS F Y - H:i e" }}</span></code></p>
            </div>
        </div>
        <div class="col-xl-1 d-lg-none d-xl-block">
            <div class="section-divider"></div>
        </div>
        <div class="col-lg-12 col-xl-8">
            <h5 class="mb-4">Regenerate API Key</h5>
            <form method="POST">
                {% csrf_token %}
                {{ form.non_field_errors }}
                {% for hidden in form.hidden_fields %}
                    {{ hidden }}
                {% endfor %}
                <div class="row">
                    <div class="col-xl-12">
                        <p class="mb-0 fw-bold">
                            <i class="icofont-check-circled me-2"></i> {{ form.confirmation.label }}<span class="text-danger">*</span>
                        </p>
                        <p class="mb-3 text-tertiary help-text"><i>{{ form.confirmation.help_text }}</i></p>
                        <input id="toggle-on" class="form-radio-toggle toggle-left" name="{{ form.confirmation.name }}" value="false" type="radio" checked>
                        <label for="toggle-on" class="form-radio-toggle-btn">No</label>
                        <input id="toggle-off" class="form-radio-toggle toggle-right" name="{{ form.confirmation.name }}" value="true" type="radio">
                        <label for="toggle-off" class="form-radio-toggle-btn">Yes</label>
                    </div>
                </div>
                <div class="row update-button" style="display:none;">
                    <div class="col-lg-12">
                        <button class="btn bg-success text-white px-5 py-2 mt-4 text-uppercase" type="submit">Reset API Key <i class="icofont-refresh ms-3"></i></i></button>
                    </div>
                </div>
                {% if update %}
                    <div class="form-errors success-message mt-4">
                        <h5 class="text-success">Success.</h5>
                        <ul>
                            <li>Your API key has been successfully re-generated.</li>
                        </ul>
                    </div>
                {% endif %}
            </form>
        </div>
    </div>
    <div class="row mt-5 pt-5" style="border-top: 1px solid var(--light-border);">
        <div class="col-xl-12">
            <h5 class="mb-4">API Request Activity</h5>
        </div>
    </div>
    <div class="row">
        <div class="col-xl-12">
            <table id="api-logs" class="display pb-3">
                <thead>
                    <tr>
                        <th class="pb-4 desktop">Timestamp</th>
                        <th class="pb-4 desktop">Formatted Date/Time</th>
                        <th class="pb-4 desktop">Request Action</th>
                        <th class="pb-4 desktop">Request Method</th>
                        <th class="pb-4 desktop">Payload Size</th>
                        <th class="pb-4 desktop">Response Code</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in api_log %}
                        <tr>
                            <td>{{ record.created|date:"U" }}</td>
                            <td>{{ record.created|date:"l jS F Y - H:i:s e" }}</td>
                            <td>{{ record.type }}</td>
                            <td>{{ record.get_method_display|upper }}</td>
                            <td>{{ record.get_payload_size }} Bytes</td>
                            <td>{{ record.response }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block page_scripts %}
<script src="https://cdn.jsdelivr.net/npm/datatables@1.10.18/media/js/jquery.dataTables.min.js" integrity="sha256-3aHVku6TxTRUkkiibvwTz5k8wc7xuEr1QqTB+Oo5Q7I=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-responsive@2.2.9/js/dataTables.responsive.min.js" integrity="sha256-f+r2TX3KkC6avpv7F8bRhVZZO8nW7xJhmCKd6k7PqGE=" crossorigin="anonymous"></script>
<script>
    $(document).ready(function(){
        $('input[type=radio][name="confirmation"]').change(function() {
            if (this.value == "true") {
                $('.update-button').show()
                $('.success-message').hide()
            }
            else {
                $('.update-button').hide()
            }
        });

        $('#api-logs').dataTable( {
            "lengthChange": false,
            "searching": false,
            "pageLength": 10,
            "order": [[ 0, 'desc' ]],
            responsive: {
                details: {
                    type: 'column',
                    target: 'tr'
                }
            },
        });
    });
</script>
{% endblock%}